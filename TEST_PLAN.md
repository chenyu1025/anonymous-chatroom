# 匿名聊天室测试计划 (Test Plan)

本文档详细描述了针对匿名聊天室各项功能的测试方案，涵盖功能测试、兼容性测试及异常测试。

## 1. 音频功能测试 (Audio Messaging)

### 1.1 录音与发送
| 测试项 | 前置条件 | 操作步骤 | 预期结果 |
| :--- | :--- | :--- | :--- |
| **正常录音** | 授予麦克风权限 | 1. 点击麦克风图标<br>2. 说话约 5 秒<br>3. 松开按钮 | 1. 出现预览弹窗<br>2. 能够播放录音预览<br>3. 声音清晰无杂音 |
| **取消录音** | 录音中 | 1. 按住麦克风并向上滑动 > 50px<br>2. 松开手指 | 1. 录音界面取消<br>2. 不显示预览弹窗<br>3. 不发送消息 |
| **过短录音** | 无 | 1. 快速点击麦克风（< 0.5s） | 1. 提示“录音时间太短”或自动忽略<br>2. 不发送消息 |
| **发送语音** | 在预览界面 | 1. 点击“发送”按钮 | 1. 消息列表中出现语音气泡<br>2. 显示时长（如有）<br>3. 收到发送成功提示音 |

### 1.2 语音播放 (重点：跨平台兼容性)
| 测试场景 | 设备 A (发送方) | 设备 B (接收方) | 预期结果 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| **iOS -> Android** | iPhone (Safari) | Android (Chrome) | Android 端能正常播放，进度条正常走动 | iOS 录制为 MP4/AAC |
| **Android -> iOS** | Android (Chrome) | iPhone (Safari) | iOS 端能正常播放，点击即播，无无限加载 | Android 录制为 WebM/Opus |
| **PC -> Mobile** | Mac/Windows | iPhone/Android | 移动端能正常播放 | PC 通常录制为 WebM |
| **自测播放** | 任意设备 | 同一设备 | 发送后自己点击播放能正常听到声音 | 验证本地缓存/URL有效性 |

### 1.3 播放器交互
- [ ] **播放/暂停切换**：点击播放图标能切换状态。
- [ ] **进度拖拽**：拖动进度条能跳转到指定时间播放。
- [ ] **多音频互斥**：播放语音 A 时，点击语音 B，A 应自动暂停。
- [ ] **加载状态**：网络慢时应显示 Loading 动画，而不是无响应。

## 2. 图片功能测试 (Image Messaging)

### 2.1 图片发送
| 测试项 | 操作步骤 | 预期结果 |
| :--- | :--- | :--- |
| **拍照/相册上传** | 1. 点击“+” -> 图片<br>2. 选择一张照片 | 1. 图片开始压缩上传（显示 Loading）<br>2. 上传成功后自动发送<br>3. 消息列表显示图片缩略图 |
| **大图发送** | 1. 选择一张 > 5MB 的高清图 | 1. 前端进行压缩<br>2. 最终上传大小应显著小于原图<br>3. 发送成功 |
| **非图片文件** | 1. 尝试选择 .pdf 或 .txt (如果系统允许) | 1. 应被过滤或提示格式不支持 |

### 2.2 图片查看
- [ ] **缩略图预览**：消息流中图片显示为固定宽高比或自适应，不应变形。
- [ ] **灯箱效果 (Lightbox)**：点击图片应全屏显示大图。
- [ ] **缩放查看**：在全屏模式下，支持双指缩放或双击放大。
- [ ] **关闭预览**：点击关闭按钮或背景应返回聊天界面。

## 3. 消息引用功能 (Reply System)

### 3.1 引用操作
| 测试项 | 操作步骤 | 预期结果 |
| :--- | :--- | :--- |
| **引用他人** | 1. 找到他人消息<br>2. 双击或点击引用按钮 | 1. 输入框上方出现引用预览条<br>2. 显示被引用人的昵称和内容预览 |
| **引用自己** | 1. 找到自己发送的消息<br>2. 点击引用按钮 | 1. 同上（新功能验证）<br>2. 昵称显示为“我”或对应身份 |
| **取消引用** | 1. 在引用状态下<br>2. 点击预览条右侧的 X | 1. 引用预览条消失<br>2. 发送消息变为普通消息 |

### 3.2 引用显示
- [ ] **文本引用**：气泡内上方显示灰色引用块，内容截断适中。
- [ ] **富媒体引用**：引用图片显示 `[图片]`，引用语音显示 `[语音]`。
- [ ] **点击跳转**：(进阶) 点击引用块应滚动到原消息位置（如果还在当前视口内）。

## 4. 实时性与状态 (Real-time & State)

- [ ] **多端同步**：开启两个浏览器窗口，A 发送消息，B 应在 1秒内 收到。
- [ ] **乐观更新**：发送消息时，界面应立即显示消息（半透明或 Loading），无需等待服务器返回。
- [ ] **发送失败处理**：断网情况下发送，应提示失败并允许重试（如有实现）。

## 5. 自动化测试建议 (Automation)

建议使用 **Playwright** 进行端到端测试。

### 推荐的测试套件结构：
1. `tests/e2e/chat.spec.ts`: 核心聊天流程（发文本、发图片模拟、引用）。
2. `tests/unit/utils.test.ts`: 工具函数测试（如时间格式化、彩蛋逻辑）。

---
**执行记录：**
- [x] iPad 播放他人语音 (已修复)
- [x] 访客引用自己消息 (已实现)
